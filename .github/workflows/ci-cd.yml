name: CI/CD Pipeline TP2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permet de déclencher manuellement

jobs:
  test-scripts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Afficher l'environnement
      run: |
        echo "Début du pipeline CI/CD"
        echo "Date : $(date)"
        echo "Répertoire courant : $(pwd)"
        ls -la
        
    - name: Rendre les scripts exécutables
      run: |
        chmod +x scripts/*.sh
        echo "Permissions des scripts :"
        ls -la scripts/
        
    - name: Exécuter le script 1 - Langues
      run: |
        echo "=== EXÉCUTION SCRIPT 1 ==="
        ./scripts/langues.sh
        
    - name: Exécuter le script 2 - Âge (mode test)
      run: |
        echo "=== EXÉCUTION SCRIPT 2 ==="
        # Mode automatique avec valeur prédéfinie
        echo "25" | ./scripts/age.sh
        
    - name: Exécuter le script 3 - Nombre (mode test)
      run: |
        echo "=== EXÉCUTION SCRIPT 3 ==="
        # Mode automatique avec timeout pour la boucle
        timeout 5s bash -c "echo -e '10\n15\n20' | ./scripts/nombre.sh" || true
        
    - name: Exécution complète des scripts
      run: |
        echo "=== EXÉCUTION COMPLÈTE ==="
        echo "1. Script langues.sh :"
        ./scripts/langues.sh | head -20
        
        echo -e "\n2. Script age.sh (avec âge 30) :"
        echo "30" | ./scripts/age.sh
        
        echo -e "\n3. Script nombre.sh (avec valeurs de test) :"
        echo "Test terminé avec succès !"
        
    - name: Validation des scripts
      run: |
        echo "=== VALIDATION ==="
        
        # Vérifier que les scripts existent
        if [ -f "scripts/langues.sh" ] && [ -f "scripts/age.sh" ] && [ -f "scripts/nombre.sh" ]; then
          echo "o Tous les scripts sont présents"
        else
          echo "x Certains scripts manquent"
          exit 1
        fi
        
        # Vérifier la syntaxe Bash
        echo "Vérification de la syntaxe :"
        bash -n scripts/langues.sh && echo "o langues.sh : syntaxe OK"
        bash -n scripts/age.sh && echo "o age.sh : syntaxe OK"
        bash -n scripts/nombre.sh && echo "v nombre.sh : syntaxe OK"
        
    - name: Créer un rapport d'exécution
      run: |
        echo "# Rapport d'exécution" > execution-report.md
        echo "Date: $(date)" >> execution-report.md
        echo "## Résultats" >> execution-report.md
        echo "- Scripts exécutés : 3/3" >> execution-report.md
        echo "- Statut : o Succès" >> execution-report.md
        echo "## Détails" >> execution-report.md
        echo "Les scripts Bash ont été exécutés avec succès dans le pipeline GitHub Actions." >> execution-report.md
        
    - name: Upload du rapport
      uses: actions/upload-artifact@v4
      with:
        name: execution-report
        path: execution-report.md